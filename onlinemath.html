<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <style>
    body { font-family: 'Kanit', sans-serif; background-color: #fff0f5; color: #555; }
    .card { border-radius: 20px; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .btn-custom { background-color: #ff99cc; color: white; border-radius: 30px; padding: 10px 30px; border: none; }
    .btn-custom:hover { background-color: #ff66b2; }
    .header-box { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); padding: 20px; border-radius: 0 0 30px 30px; margin-bottom: 20px; }
    .footer-credit { position: fixed; bottom: 0; width: 100%; text-align: center; background: #fff; padding: 10px; font-size: 12px; color: #888; border-top: 1px solid #eee; }
    .hidden { display: none; }
    .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 15px; }
    .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    
    /* Teacher Specific */
    .teacher-panel { background-color: #e6f7ff; }
  </style>
</head>
<body>

  <div id="loginPage" class="container mt-5">
    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="card p-5 text-center">
          <h2 class="mb-4">üéÄ ‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô üéÄ</h2>
          <h5 class="text-muted mb-4">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h5>
          <input type="text" id="username" class="form-control mb-3" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Username)" style="border-radius:20px;">
          <input type="password" id="password" class="form-control mb-4" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Password)" style="border-radius:20px;">
          <button class="btn btn-custom w-100" onclick="doLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
      </div>
    </div>
  </div>

  <div id="studentPage" class="container-fluid hidden">
    <div class="header-box text-center">
      <h3>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏ô‡πÄ‡∏Å‡πà‡∏á: <span id="stName"></span></h3>
      <p>‡∏´‡πâ‡∏≠‡∏á: <span id="stClass"></span></p>
      <button class="btn btn-sm btn-outline-danger" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <div class="container">
      <div class="row">
        <div class="col-md-4 mb-3">
          <div class="card p-3">
            <h5>üìö ‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h5>
            <div id="lessonList" class="list-group list-group-flush">
              </div>
          </div>
          <div class="card p-3 mt-3">
            <h5>üìä ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤</h5>
            <div id="progressStats">Loading...</div>
          </div>
        </div>

        <div class="col-md-8">
          <div id="learningArea" class="card p-4 hidden">
            <h4 id="currentLessonTitle">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°</h4>
            <div class="video-container mt-3">
              <div id="player"></div>
            </div>
            
            <div id="assignmentArea" class="mt-4 hidden text-center p-3" style="background: #e8f5e9; border-radius: 15px;">
              <h5>üéâ ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß!</h5>
              <p>‡∏ó‡∏≥‡∏†‡∏≤‡∏£‡∏∞‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p>
              <a id="assignLink" href="#" target="_blank" class="btn btn-success rounded-pill" onclick="markAssignmentDone()">üìù ‡πÑ‡∏õ‡∏ó‡∏≥‡∏†‡∏≤‡∏£‡∏∞‡∏á‡∏≤‡∏ô</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="teacherPage" class="container-fluid teacher-panel hidden" style="min-height: 100vh;">
    <div class="header-box text-center bg-white">
      <h3>üë®‚Äçüè´ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô (‡∏Ñ‡∏£‡∏π)</h3>
      <button class="btn btn-sm btn-outline-danger" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <div class="container mt-4">
      <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-add" type="button">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-report" type="button" onclick="loadReport()">‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠/‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</button></li>
      </ul>
      
      <div class="tab-content" id="pills-tabContent">
        <div class="tab-pane fade show active" id="pills-add">
          <div class="card p-4">
            <h5>‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</h5>
            <input type="text" id="tTopic" class="form-control mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á">
            <input type="text" id="tVideo" class="form-control mb-2" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå YouTube (Full URL)">
            <input type="text" id="tQuestion" class="form-control mb-2" placeholder="‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡πà‡∏°‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Ñ‡∏•‡∏¥‡∏õ">
            <input type="text" id="tAnswer" class="form-control mb-2" placeholder="‡πÄ‡∏â‡∏•‡∏¢‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö">
            <input type="text" id="tAssign" class="form-control mb-2" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏£‡∏∞‡∏á‡∏≤‡∏ô (Google Form/Docs)">
            <button class="btn btn-primary mt-2" onclick="saveLesson()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
          </div>
        </div>

        <div class="tab-pane fade" id="pills-report">
          <div class="card p-4">
            <h5>üìã ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h5>
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏´‡πâ‡∏≠‡∏á</th><th>‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th><th>‡∏î‡∏π‡πÑ‡∏õ(‡∏ô‡∏≤‡∏ó‡∏µ)</th><th>‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</th>
                  </tr>
                </thead>
                <tbody id="reportTableBody">
                  </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="footer-credit">
    ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÇ‡∏î‡∏¢ ‡∏ô‡∏≤‡∏¢‡∏ß‡∏∏‡∏í‡∏¥‡∏ä‡∏±‡∏¢ ‡∏ô‡∏∏‡πà‡∏°‡∏ô‡πâ‡∏≠‡∏¢
  </div>

  <script src="https://www.youtube.com/iframe_api"></script>

  <script>
    var currentUser = {};
    var currentLesson = {};
    var player;
    var timer;
    var hasPoppedUp = false;
    var watchSeconds = 0;

    // --- Login Logic ---
    function doLogin() {
      var u = document.getElementById('username').value;
      var p = document.getElementById('password').value;
      
      Swal.fire({title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...', didOpen: () => { Swal.showLoading() }});
      
      google.script.run.withSuccessHandler(function(res){
        Swal.close();
        if(res.status == 'fail') {
          Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'User ‡∏´‡∏£‡∏∑‡∏≠ Password ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
        } else if (res.status == 'teacher') {
          showPage('teacherPage');
        } else {
          currentUser = res;
          document.getElementById('stName').textContent = res.name;
          document.getElementById('stClass').textContent = res.classRoom;
          showPage('studentPage');
          loadStudentContent();
        }
      }).checkLogin(u, p);
    }

    function showPage(pageId) {
      document.getElementById('loginPage').classList.add('hidden');
      document.getElementById('studentPage').classList.add('hidden');
      document.getElementById('teacherPage').classList.add('hidden');
      document.getElementById(pageId).classList.remove('hidden');
    }

    function logout() {
      location.reload();
    }

    // --- Student Logic ---
    function loadStudentContent() {
      google.script.run.withSuccessHandler(function(data){
        var listHtml = '';
        var lessons = data.lessons;
        
        // Render Lesson List
        lessons.forEach(function(ls, index){
          // ‡πÅ‡∏õ‡∏•‡∏á Object ‡πÉ‡∏´‡πâ String ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô
          var lsStr = JSON.stringify({
            id: ls[0], topic: ls[1], vid: ls[2], 
            q: ls[3], ans: ls[4], work: ls[5]
          }).replace(/"/g, '&quot;');
          
          listHtml += `<button class="list-group-item list-group-item-action" onclick="startLesson(${lsStr})">
            üì∫ ${ls[1]}
          </button>`;
        });
        document.getElementById('lessonList').innerHTML = listHtml;
        
        // Render Stats
        var totalWatched = 0;
        var submittedCount = 0;
        data.progress.forEach(p => {
          totalWatched += p[5]; // col F
          if(p[8] == 'Submitted') submittedCount++;
        });
        document.getElementById('progressStats').innerHTML = `
          <p>‡∏î‡∏π‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏£‡∏ß‡∏°: <span class="fw-bold text-primary">${(totalWatched).toFixed(1)}</span> ‡∏ô‡∏≤‡∏ó‡∏µ</p>
          <p>‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß: <span class="fw-bold text-success">${submittedCount}</span> ‡∏á‡∏≤‡∏ô</p>
        `;
        
      }).getStudentData(currentUser.username);
    }

    function startLesson(lsData) {
      currentLesson = lsData;
      document.getElementById('learningArea').classList.remove('hidden');
      document.getElementById('currentLessonTitle').textContent = lsData.topic;
      document.getElementById('assignmentArea').classList.add('hidden');
      
      // Reset State
      hasPoppedUp = false;
      watchSeconds = 0;
      
      if(player) {
        player.loadVideoById(lsData.vid);
      } else {
        player = new YT.Player('player', {
          height: '360',
          width: '100%',
          videoId: lsData.vid,
          events: {
            'onStateChange': onPlayerStateChange
          }
        });
      }
    }

    function onPlayerStateChange(event) {
      if (event.data == YT.PlayerState.PLAYING) {
        startTimer();
      } else {
        stopTimer();
      }
      
      // ‡∏à‡∏ö‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠
      if (event.data == YT.PlayerState.ENDED) {
        document.getElementById('assignmentArea').classList.remove('hidden');
        document.getElementById('assignLink').href = currentLesson.work;
        saveProgress(100, 'Finished');
      }
    }

    function startTimer() {
      timer = setInterval(function() {
        watchSeconds++;
        var currentTime = player.getCurrentTime();
        
        // ‡∏™‡∏∏‡πà‡∏°‡∏ñ‡∏≤‡∏° (Logic: ‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤ > 5 ‡∏ô‡∏≤‡∏ó‡∏µ ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏≤‡∏°‡∏Å‡∏≥‡∏´‡∏ô‡∏î)
        // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡∏ú‡∏°‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ú‡∏• (‡πÅ‡∏Å‡πâ‡πÄ‡∏•‡∏Ç 30 ‡πÄ‡∏õ‡πá‡∏ô 300 ‡∏Ñ‡∏∑‡∏≠ 5 ‡∏ô‡∏≤‡∏ó‡∏µ)
        var triggerTime = 300; 
        
        if(currentTime > triggerTime && !hasPoppedUp) {
           player.pauseVideo();
           hasPoppedUp = true;
           askRandomQuestion();
        }
        
      }, 1000);
    }

    function stopTimer() {
      clearInterval(timer);
    }

    function askRandomQuestion() {
      Swal.fire({
        title: 'üß† ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à',
        text: currentLesson.q,
        input: 'text',
        confirmButtonText: '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö',
        allowOutsideClick: false
      }).then((result) => {
        if (result.value) {
          var isCorrect = (result.value.trim() == currentLesson.ans);
          Swal.fire(isCorrect ? '‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å!' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ô‡∏∞', isCorrect ? '‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á' : '‡πÄ‡∏â‡∏•‡∏¢: ' + currentLesson.ans, isCorrect ? 'success' : 'info')
          .then(() => player.playVideo());
        }
      });
    }
    
    function markAssignmentDone() {
      saveProgress(100, 'Submitted');
    }

    function saveProgress(percent, assignStatus) {
      var pData = {
        username: currentUser.username,
        name: currentUser.name,
        classRoom: currentUser.classRoom,
        lessonId: currentLesson.id,
        watchDuration: (watchSeconds / 60).toFixed(2),
        watchPercent: percent,
        quizResult: 'Answered', // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡πà‡∏≤‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß
        assignmentStatus: assignStatus
      };
      google.script.run.saveStudentProgress(pData);
    }

    // --- Teacher Logic ---
    function saveLesson() {
      var data = {
        topic: document.getElementById('tTopic').value,
        videoUrl: document.getElementById('tVideo').value,
        question: document.getElementById('tQuestion').value,
        answer: document.getElementById('tAnswer').value,
        assignmentLink: document.getElementById('tAssign').value
      };
      google.script.run.withSuccessHandler(res => {
        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', res, 'success');
        document.getElementById('tTopic').value = '';
      }).addLesson(data);
    }

    function loadReport() {
      google.script.run.withSuccessHandler(data => {
        var html = '';
        data.forEach(row => {
          // Format Date
          var d = new Date(row[0]);
          var dateStr = d.toLocaleDateString('th-TH') + ' ' + d.toLocaleTimeString('th-TH');
          
          html += `<tr>
            <td><small>${dateStr}</small></td>
            <td>${row[2]}</td>
            <td>${row[3]}</td>
            <td>${row[4]}</td>
            <td>${row[5]}</td>
            <td><span class="badge ${row[8]=='Submitted'?'bg-success':'bg-warning'}">${row[8]}</span></td>
          </tr>`;
        });
        document.getElementById('reportTableBody').innerHTML = html;
      }).getReportData();
    }
  </script>
</body>
</html>
