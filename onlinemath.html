<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Basic Math Learning</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <style>
    body { font-family: 'Kanit', sans-serif; background-color: #fff0f5; color: #555; }
    .card { border-radius: 20px; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .btn-custom { background-color: #ff99cc; color: white; border-radius: 30px; padding: 10px 30px; border: none; }
    .btn-custom:hover { background-color: #ff66b2; }
    .header-box { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); padding: 20px; border-radius: 0 0 30px 30px; margin-bottom: 20px; }
    .footer-credit { position: fixed; bottom: 0; width: 100%; text-align: center; background: #fff; padding: 10px; font-size: 12px; color: #888; border-top: 1px solid #eee; }
    .hidden { display: none !important; }
    .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 15px; }
    .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
  </style>
</head>
<body>

  <div id="loginPage" class="container mt-5">
    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="card p-5 text-center">
          <h2 class="mb-4">üéÄ ‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô üéÄ</h2>
          <input type="text" id="username" class="form-control mb-3" placeholder="Username">
          <input type="password" id="password" class="form-control mb-4" placeholder="Password">
          <button class="btn btn-custom w-100" onclick="handleLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
      </div>
    </div>
  </div>

  <div id="studentPage" class="container-fluid hidden">
    <div class="header-box text-center">
      <h3>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö: <span id="stName"></span></h3>
      <button class="btn btn-sm btn-outline-danger" onclick="logout()">Logout</button>
    </div>
    <div class="container">
      <div class="row">
        <div class="col-md-4"><div class="card p-3" id="lessonList">Loading...</div></div>
        <div class="col-md-8">
          <div id="learningArea" class="card p-4 hidden">
             <h4 id="lessonTitle"></h4>
             <div class="video-container mt-2"><div id="player"></div></div>
             <div id="assignArea" class="mt-3 hidden text-center"><a id="workLink" target="_blank" class="btn btn-success" onclick="markDone()">‡∏ó‡∏≥‡∏†‡∏≤‡∏£‡∏∞‡∏á‡∏≤‡∏ô</a></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="teacherPage" class="container hidden">
    <div class="header-box text-center"><h3>‡πÇ‡∏´‡∏°‡∏î‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô</h3><button class="btn btn-sm btn-outline-danger" onclick="logout()">Logout</button></div>
    <div class="card p-4 mb-3">
        <h5>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h5>
        <input id="tTop" class="form-control mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á">
        <input id="tVid" class="form-control mb-2" placeholder="Youtube Link">
        <input id="tQ" class="form-control mb-2" placeholder="‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°">
        <input id="tA" class="form-control mb-2" placeholder="‡πÄ‡∏â‡∏•‡∏¢">
        <input id="tW" class="form-control mb-2" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏á‡∏≤‡∏ô">
        <button class="btn btn-primary" onclick="addLesson()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
    <div class="card p-4">
        <h5>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h5>
        <button class="btn btn-info mb-2" onclick="getReport()">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        <div id="reportArea"></div>
    </div>
  </div>

  <div class="footer-credit">‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÇ‡∏î‡∏¢ ‡∏ô‡∏≤‡∏¢‡∏ß‡∏∏‡∏í‡∏¥‡∏ä‡∏±‡∏¢ ‡∏ô‡∏∏‡πà‡∏°‡∏ô‡πâ‡∏≠‡∏¢</div>
  <script src="https://www.youtube.com/iframe_api"></script>

  <script>
    // ******************************************************
    // ‡∏ô‡∏≥ URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1 ‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ (‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏û‡∏π‡∏î)
    const API_URL = 'https://script.google.com/macros/s/xxxxxxxxx/exec'; 
    // ******************************************************

    let currentUser = {}, currentLesson = {}, player, timer;

    async function callApi(action, payload = {}) {
        payload.action = action;
        const res = await fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify(payload)
        });
        return await res.json();
    }

    function handleLogin() {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        Swal.fire({didOpen:()=>Swal.showLoading()});
        
        callApi('login', {username:u, password:p}).then(res => {
            Swal.close();
            if(res.status == 'fail') Swal.fire('Error','Login Failed','error');
            else if(res.status == 'teacher') switchPage('teacherPage');
            else {
                currentUser = res;
                document.getElementById('stName').innerText = res.name;
                switchPage('studentPage');
                loadStudentData();
            }
        });
    }

    function loadStudentData() {
        callApi('getStudentData', {username: currentUser.username}).then(res => {
            let html = '';
            res.lessons.forEach(l => {
                let obj = JSON.stringify({id:l[0], topic:l[1], vid:l[2], q:l[3], ans:l[4], work:l[5]}).replace(/"/g, '&quot;');
                html += `<button class="btn btn-light w-100 mb-2 text-start" onclick="startLesson(${obj})">üì∫ ${l[1]}</button>`;
            });
            document.getElementById('lessonList').innerHTML = html;
        });
    }

    function startLesson(ls) {
        currentLesson = ls;
        document.getElementById('learningArea').classList.remove('hidden');
        document.getElementById('lessonTitle').innerText = ls.topic;
        document.getElementById('assignArea').classList.add('hidden');
        if(player) player.loadVideoById(ls.vid);
        else player = new YT.Player('player', { height: '360', width: '100%', videoId: ls.vid, events: {'onStateChange': onPlayerStateChange} });
    }

    function onPlayerStateChange(event) {
        if(event.data == YT.PlayerState.PLAYING) {
            timer = setTimeout(() => {
                player.pauseVideo();
                Swal.fire({title: currentLesson.q, input: 'text'}).then((r)=>{
                    if(r.value.trim() == currentLesson.ans) Swal.fire('Correct!').then(()=>player.playVideo());
                    else Swal.fire('Wrong', 'Answer is '+currentLesson.ans, 'info').then(()=>player.playVideo());
                });
            }, 300000); // 5 ‡∏ô‡∏≤‡∏ó‡∏µ (300000ms)
        }
        if(event.data == YT.PlayerState.ENDED) {
            document.getElementById('assignArea').classList.remove('hidden');
            document.getElementById('workLink').href = currentLesson.work;
        }
    }

    function markDone() {
        callApi('saveProgress', {
            username: currentUser.username, name: currentUser.name, classRoom: currentUser.classRoom,
            lessonId: currentLesson.id, watchDuration: 'End', watchPercent: 100, quizResult: 'Done', assignmentStatus: 'Submitted'
        });
    }

    function addLesson() {
        callApi('addLesson', {
            topic: document.getElementById('tTop').value, videoUrl: document.getElementById('tVid').value,
            question: document.getElementById('tQ').value, answer: document.getElementById('tA').value, assignmentLink: document.getElementById('tW').value
        }).then(r => Swal.fire(r));
    }

    function getReport() {
        callApi('getReport').then(data => {
            let html = '<table class="table"><tr><th>Date</th><th>Name</th><th>Lesson</th></tr>';
            data.forEach(r => html += `<tr><td>${new Date(r[0]).toLocaleDateString()}</td><td>${r[2]}</td><td>${r[4]}</td></tr>`);
            html += '</table>';
            document.getElementById('reportArea').innerHTML = html;
        });
    }

    function switchPage(id) {
        ['loginPage','studentPage','teacherPage'].forEach(p => document.getElementById(p).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }
    function logout() { location.reload(); }
  </script>
</body>
</html>
